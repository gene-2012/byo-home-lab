# Build Your Own Home-LAB Part 2 Div 2. Soft Routing

> 在上一 Div 中，我们初步了解了计算机网络结构，并引入了软路由的概念，本章中，我们将围绕 OpenWRT 的衍生版本——iStoreOS 搭建一个切实可用的软路由系统。

---

## 0x01 💡什么是 OpenWRT 项目？

![](/image/P2D2_1_OpenWrt_Logo.svg)

OpenWrt 项目是一个面向嵌入式设备的 Linux 操作系统。与传统路由器的“固件烧录完就只能认命”不同，OpenWrt 提供了一个完全**可写**的文件系统和完善的软件包管理功能，简直就是“路由器中的 Arch Linux”。

你可以把 OpenWrt 想象成一台可以自由扩展插件的变形金刚，不仅能当路由器，还能跑 DNS、广告屏蔽、VPN、Docker……甚至还能跑 Minecraft（虽然我不推荐~~并且好像也没多少人做过~~ 😅）。这种灵活性，让它成为了许多极客和网络爱好者的最爱。

它本身是一个社区驱动的开源项目，支持各种路由器和 SBC（单板机），有时候你会在极客论坛、矿渣群、黑群晖教程里频繁看到它的名字。

当然可以，下面是对你提供的 **0x02 设备选择** 段落的重写版本，语气依然保持严谨技术风格中带点轻松，细节更为清晰和流畅，逻辑稍作整理：

---

## 0x02 设备选择

搭建软路由系统的第一步，不是下载系统，也不是写入镜像，而是选择一台合适的设备。在功能性和实用性之间取得平衡，才能构建出真正稳定高效的家庭网络核心。这部分内容你可以参考本系列的第一篇文章 [《Introduction & Hard Ware》](P1_Introduction_Hard_Ware.md#0x02-02-如何购买适合自己的-home-lab)。通常，我们选择软路由设备有一下几个因素。

### 以太网接口数量：不求多，但要刚好

作为一台路由器，**最基础的要求就是至少具备两个以太网接口**：

* 一个作为 **WAN 接口**，连接上级光猫；
* 一个作为 **LAN 接口**，连接家庭内网。

听起来简单，但实际中有些细节值得注意：

* **接口不要太多**。有些工控机带 4～6 个 RJ45 接口，看起来很香，实际上反而可能带来问题：网口越多，流量同时汇入 CPU 的中断和网络芯片的负载越高，反而会降低系统稳定性。
* 最推荐的方案是：**一个 LAN 接口接入交换机**，交换机再将网络分发至各终端，既节省资源又利于网络结构清晰。
* 如果你希望软路由兼具 AP 功能，也可以选用带有无线网卡（支持 AP 模式）的设备。但请注意，不是所有无线网卡都适合做无线热点，推荐优先考虑 Intel 或 Atheros 芯片的卡。


### 电力需求：低功耗是王道

软路由作为家庭网络的中枢，需要 **7×24 小时运行**。因此，能效比（性能/功耗）是非常关键的指标。

* **ARM 架构设备**（如树莓派、NanoPi R5S 等）通常是低功耗设备中的佼佼者，能做到稳定运行同时维持个位数瓦数的功耗。
* 如果你更偏向 x86 架构（比如用旧笔记本、N100 工控机），也建议选择 **低功耗版本的 CPU**，如 Intel J1900、N5105、N100 等。

这不仅能降低电费账单，还能让设备发热更小、寿命更长。

---

### 体积：考虑你的弱电箱

最后一个容易被忽视的点：**体积**。

很多家庭的网络设备都被集中收纳在一个狭小的弱电箱中，如果你的设备像个台式机主机箱一样庞大，那它注定无法进入这片狭小的天地。

因此，优先考虑：

* **Mini-PC、工控机**：体积小巧，接口丰富，适合固定安装；
* **板卡类设备（如树莓派、NanoPi）**：小到可以藏在交换机后面，用双面胶贴墙都行。

在保证散热的前提下，小体积往往意味着更容易部署和维护。

## 0x03 安装 iStoreOS：从镜像到启动

在选定了合适的设备之后，接下来我们要正式安装 iStoreOS。本节将分别介绍在 **树莓派（ARM 架构）** 和 **x86 设备（虚拟机或裸机）** 上的安装方式。

---

### 3.1 在树莓派上安装 iStoreOS

树莓派是很多极客玩家的最爱，低功耗、小体积、社区活跃，自然也成为搭建软路由的热门选择之一。以树莓派 4B 为例，我们可以按以下步骤安装 iStoreOS：

#### Step 1：获取镜像

前往 [iStoreOS 官方镜像站](https://fw.koolcenter.com/iStoreOS/rpi4/) 下载适用于树莓派的系统镜像，通常命名为类似：

```

istoreos-arm64-rpi4-*.img.gz
```



下载完成后解压：

```bash
gzip -d istoreos-arm64-rpi4-*.img.gz
```

> [!tip]
> 如果你使用的是路由器设备，你可以在 [Kwrt](https://openwrt.ai) 上获取镜像。
> 
> Kwrt 的镜像包内置 iStoreOS 的商店等部分功能，并且可以为自己的路由器量身定制一套固件。
>
> 不过你需要提前刷入一个 OpenWrt 官方镜像，然后在系统升级里进行刷入。
>
> 并且固件默认 IP 是 10.0.0.1，而非 iStoreOS 的 192.168.100.1，不过后期可以更改。同时该镜像还不会包含 iStoreOS 的图标以及搜索功能（不过并不影响）。
> 
> （如果这里头还是没有的话就先用 OpenWrt 官方镜像凑合用吧，也不太会影响正常使用~~虽然不如 iStoreOS 方便~~）

#### 💾 Step 2：写入 TF 卡

使用 `dd` 或者 `balenaEtcher` 将 `.img` 写入一张高速 TF 卡（建议使用 ≥16GB 的 UHS-I 卡）：

```bash
sudo dd if=istoreos-arm64-rpi4.img of=/dev/sdX bs=4M status=progress conv=fsync
```



> ⚠️ 注意替换 `/dev/sdX` 为你实际插入的 TF 卡路径，否则容易酿成“数据灭顶之灾”。

#### Step 3：首次启动

将 TF 卡插入树莓派，接通电源，等待数十秒，系统将通过串口或 HDMI 输出启动信息。

* 默认用户名：`root`
* 默认密码：`password`

你可以通过串口、HDMI+键盘，或者查找局域网 IP 后通过 SSH 登录系统。

#### Step 4：配置网络

由于树莓派默认只有一个网口，默认作为 LAN 口，需连接到上级路由器。
登录系统后，可通过命令行或 Web 界面配置网络参数，设置静态 IP 或 DHCP，以便于管理。

---

### 🖥 3.2 在 x86 上安装 iStoreOS

如果你使用的是工控机、NUC、小主机，甚至是老旧笔记本，那么你大概率需要安装 iStoreOS 的 x86 版本。这里介绍两种常见的安装场景：**虚拟化安装（KVM/QEMU）** 和 **裸机安装（写盘启动）**。

---

#### A. 虚拟机安装（适合测试、开发）

如果你搭建了诸如 PVE、eSXI 这样的虚拟化平台，那么太棒了，iStoreOS 在这些平台上的操作相当简单。iStoreOS 提供了适用于 Legacy BIOS 启动的 `.img` 镜像，可以直接作为硬盘使用。

##### 步骤：

1. 下载镜像（推荐 Legacy 版）：

   ```
   istoreos-x86-legacy-*.img
   ```



2. 转换为 qcow2 格式（适用于 QEMU）：

   ```bash
   qemu-img convert -f raw -O qcow2 istoreos-x86-legacy.img istoreos.qcow2
   ```



3. 使用 QEMU 启动：

   ```bash
   qemu-system-x86_64 \
     -machine q35 \
     -m 512M \
     -smp 2 \
     -drive file=istoreos.qcow2,if=virtio,format=qcow2 \
     -nic user,model=virtio-net-pci \
     -nographic
   ```



4. 系统启动后默认登录：

   * 用户名：`root`
   * 密码：`password`

5. 根据需要修改 `/etc/config/network` 配置网络。


#### B. 裸机安装（适合家庭部署）

裸机安装就是直接把系统写入硬盘，就像烧录路由器固件一样。

##### 步骤：

1. 下载 `.img` 镜像：

   ```
   istoreos-x86-legacy-*.img
   ```

2. 使用 `Rufus` 将镜像写入 U 盘：

   * 插入 U 盘，打开 Rufus 工具，选择下载好的固件，把固件写入到 U 盘。有关 Rufus 的使用方法，在此不再赘述，请自行搜索学习。

3. 将 U 盘、键盘、显示器接入 x86 设备，开机按 `F11`（或其他启动菜单键）选择从 U 盘启动。

4. 进入 U 盘系统，在 GRUB 菜单中无脑回车，直到屏幕上出现 `PRESS ENTER TO ACTIVATE THE CONSOLE`，输入：

   ```bash
   quickstart
   ```



选择 `Install X86`，按提示确认安装到内置硬盘。

1. 安装完成后，拔掉外接设备（U 盘/键盘等），插入网线，通电启动。

2. 登录管理后台：

   * 默认 IP：`http://192.168.100.1`
   * 默认用户名：`root`
   * 默认密码：`password`

> 💡 如果只有一个网口，默认的网口是 LAN；如果大于一个网口，默认 eth0 是 WAN 口，其它都是 LAN。

更多详细的安装步骤和图示，您可以参考以下博客文章：

* [物理机安装Istore OS软路由 - 南塘黑群晖菌](https://www.cnblogs.com/ynas/p/17429011.html)

好的，我们可以在保持整体段落连贯、幽默又严谨风格的基础上，加入少量小标题和一张表格，帮助读者更清晰地对比主路由与旁路由的差异，同时不打断阅读节奏：

---

## 0x04 主路由还是旁路由？

在我们动手配置 iStoreOS 网络接口之前，有一个哲学层面的问题你必须先解决：你的软路由，到底是要“上位”，接管整个家庭网络的控制权？还是只在一旁默默辅助，做一个稳定高效的“功能扩展包”？这就是主路由（接手一切）和旁路由（插手一角）之间的最大区别。

### 什么是“主路由”？

如果你拥有一台性能过硬、网口足够的设备（比如双千兆网口的 x86 小主机），你想要把家庭网络全部掌控在自己手里，控制 NAT、防火墙、DHCP、DNS、VLAN、QoS 等等，那你就是主路由的最佳人选。此时软路由会直接连接到光猫（或者运营商网关桥接后的 LAN 口），承担整个局域网的核心枢纽作用——你说了算，谁都不能插嘴。

当然，选择这条路也意味着你要替换掉原有的主路由，重新配置一整套网络架构。从拨号上网开始到终端分配，全部由你一个人管理，这就像从租房变成自建别墅，权力是有了，责任也更重了。

### 那“旁路由”又是什么？

但如果你手里只有一块树莓派，或者一台只有单网口的老笔记本，你不打算或者不能替换光猫/运营商路由器，那就别勉强上位了。让你的软路由做个“旁路由”，专注搞定几项特定任务，比如科学上网、广告屏蔽、智能分流、访问控制等，也是一个非常实用的方案。

旁路由模式的好处是不会破坏原有网络结构，只需通过一个 LAN 接口接入现有网络，并在主路由或终端上做些配置，旁路由就能开始工作。它就像你在系统里加装的外挂，操作不多，效果立竿见影，出问题也好撤退。

### 一张表看懂区别

| 项目      | 主路由模式                | 旁路由模式            |
| ------- | -------------------- | ---------------- |
| 部署位置    | 接在光猫后，作为网络核心         | 接在主路由 LAN 后，辅助工作 |
| 所需网口数量  | 至少两个（WAN + LAN）      | 至少一个即可           |
| 功能覆盖    | 拨号、DHCP、DNS、防火墙等全权负责 | 仅负责指定流量或功能模块     |
| 设备性能要求  | 高，需支持长时间运行和流量转发      | 中等，功能型处理为主       |
| 对现有网络改动 | 大，需要替换主路由            | 小，原网络结构保持不变      |
| 上手难度    | 高，需要理解完整网络架构         | 中，需配置策略但结构简单     |
| 推荐人群    | 网络重度玩家、技术发烧友         | 日常用户、有特定需求的普通用户  |

### 如何选择？

如果你是一个喜欢掌控一切的网络管理员，追求可定制性、想要让每个数据包都走在你划定的轨道上，那就选择主路由模式，重新定义你的家庭网络结构。如果你只是想在原有网络中加入某些“增强功能”，比如部署 adblock 或分流规则，同时又不想折腾太多，那旁路由模式是更理性的选择。

说到底，主路由是一种全权负责的“重构”，而旁路由则像是一个“外挂补丁”。两者没有高低之分，只有适不适合你当前的网络状态、设备条件和管理能力。

## 0x05 进阶玩法

### Zerotier 异地组网

相信不少读者都看到过有关于异地组网的广告。它可以把不同地区、不同型号的设备统筹在一个大内网中，这可以帮助你在外地私密地访问本地网络中的照片等资源。本节，我们选用 Zerotier，实现这个功能。

- 第一步：创建一个 Zerotier 账户，并新建一个频道，选择合适的 IP 段，记住网络 ID，这个后面要用。
  ![Zerotier](/image/P2D2_2_Zerotier.png)
- 第二步：在 OpenWRT 中，安装 Zerotier 插件，并加入网络，打开允许客户端 NAT。
  > 在没有 iStoreOS 的 OpenWrt 镜像上，其对应软件包为 luci-app-zerotier。
  
  ![Install Zerotier Extendtion](/image/P2D2_3_InstallZerotierExtendtion.png)
  ![Join Network](/image/P2D2_4_JoinNetwork.png)
- 第三步：在“网络-接口”中添加一个新接口，命名为 Zerotier，类型为**静态地址**，在设备栏选择以 `zt` 开头的网卡。将 IPV4 地址设为你在 Zerotier 管理页看到的虚拟地址；在“网络-防火墙-自定义规则”中输入下列 iptable 策略如下：
  ```plain
  iptables -I FORWARD -i ztxxxxx -j ACCEPT
  iptables -I FORWARD -o ztxxxxx -j ACCEPT
  iptables -t nat -I POSTROUTING -o ztxxxxx -j MASQUERADE
  // 把 ztxxxxx 替换成你的网卡名称
  ```
  ![Interface](/image/P2D2_5_ZerotierInterface.png)

- 第四步：在 Zerotier 中配置静态路由，例如：`192.168.1.0/24 -> xxx.xxx.xxx.xxx`。

这样，一个初步的 Zerotier 内网就搭建完成了，你可以如法炮制，将多个内网组合起来，组成一个跨地域的虚拟网络。

## 0x06 结语

在本章中，我们从 OpenWrt 项目讲起，介绍了软路由设备的选择标准，并详细演示了如何在树莓派和 x86 设备上安装 iStoreOS。随后，我们深入探讨了主路由与旁路由的部署模式，帮助你根据自身需求做出选择。最后，还简单介绍了 Zerotier 异地组网这一进阶玩法，让你的家庭网络不再受限于地理位置。

软路由的魅力，在于它不仅仅是一个“转发数据包”的工具，而是一个可以不断扩展、不断升级的平台。你可以把它当作广告过滤器、DNS 服务器、防火墙、远程访问入口，甚至是家庭 IoT 控制中心。只要你愿意折腾，它的可能性几乎是无限的。

如果你对本期主题很感兴趣，那么可以参考 B 站 UP 主 @科技宅小明 的这个系列内容：[《网络玩好了有多爽》](https://space.bilibili.com/5626102/lists/6333?type=season)。

下一期，我们在这个网络中加入 NAS 服务器，实现局域网中的文件共享。
